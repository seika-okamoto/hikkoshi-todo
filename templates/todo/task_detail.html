{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/task_detail.css' %}">
{% endblock %}


{% block content %}
<div class="task-detail-wrapper">
    <!-- âœ… æ å†…å·¦ä¸Šã«ã€Œâ† æˆ»ã‚‹ã€ -->
  <p class="back-link-inside">
    <a href="{% url 'todo:index' %}">â† æˆ»ã‚‹</a>
  </p>

<h2>{{ task.title }}</h2>

<!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
<p>
  <a href="?view=memo"
     {% if view == "memo" %}style="font-weight:bold;"{% endif %}>ğŸ“ãƒ¡ãƒ¢</a> |

  {% if sort %}
    <a href="?view=comment&sort={{ sort }}"
       {% if view == "comment" %}style="font-weight:bold;"{% endif %}>ğŸ’¬ã‚³ãƒ¡ãƒ³ãƒˆ</a>
  {% else %}
    <a href="?view=comment"
       {% if view == "comment" %}style="font-weight:bold;"{% endif %}>ğŸ’¬ã‚³ãƒ¡ãƒ³ãƒˆ</a>
  {% endif %}
</p>

<!-- âœ… ãƒ¡ãƒ¢è¡¨ç¤ºï¼ˆviewãŒmemoã®ã¨ãã ã‘ï¼‰ -->
{% if view == "memo" %}
  <h3>ğŸ“ è‡ªåˆ†ç”¨ãƒ¡ãƒ¢</h3>

  {% for memo in memos %}
    <div class="task-card">
      <div class="task-left">
        <span class="task-title">ãƒ»{{ memo.context }}ï¼ˆ{{ memo.created|date:"Y/m/d H:i" }}ï¼‰</span>
      </div>
      <div class="task-actions">
        <button class="edit-memo-btn" data-memo-id="{{ memo.id }}" data-context="{{ memo.context }}">ğŸ“ç·¨é›†</button>
        <button class="delete-memo-btn" data-memo-id="{{ memo.id }}">ğŸ—‘ï¸å‰Šé™¤</button>
      </div>
    </div>
  

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal edit-modal" id="edit-memo-modal-{{ memo.id }}" style="display:none;">
      <p class="modal-title">å†…å®¹ã‚’ç·¨é›†ã—ã¦ãã ã•ã„</p>
      <form method="POST" action="{% url 'todo:edit_memo' memo.id %}">
        {% csrf_token %}
        <textarea name="context">{{ memo.context }}</textarea><br>
        <button type="submit">âœ…ä¿å­˜</button>
        <button type="button" class="cancel-btn">âŒã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </form>
    </div>

    <!-- å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal delete-modal" id="delete-memo-modal-{{ memo.id }}" style="display:none;">
      <p style="margin-bottom: 16px;">ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
      <form method="POST" action="{% url 'todo:delete_memo' memo.id %}">
        {% csrf_token %}
        <button type="submit">ğŸ—‘ï¸å‰Šé™¤</button>
        <button type="button" class="cancel-btn">âŒã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </form>
    </div>
  {% endfor %}

  <!-- ãƒ¡ãƒ¢è¿½åŠ  -->
  <form method="POST" action="{% url 'todo:add_memo' task.id %}">
      {% csrf_token %}
      <textarea name="context" rows="3" cols="40" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea><br>
      <button type="submit" class="btn">ï¼‹ ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
  </form>
{% endif %}

<!-- âœ… ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºï¼ˆviewãŒmemoã¾ãŸã¯commentã®ã¨ãï¼‰ -->
{% if view == "memo" or view == "comment" and task.is_template %}
  <h3>ğŸ’¬ ã¿ã‚“ãªã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ{{ comment_count }}ä»¶ï¼‰</h3>

  <p>ä¸¦ã³æ›¿ãˆï¼š
    <a href="?view=comment&sort=popular" {% if sort == 'popular' %}style="font-weight: bold;"{% endif %}>äººæ°—é †</a> /
    <a href="?view=comment&sort=newest" {% if sort == 'newest' %}style="font-weight: bold;"{% endif %}>æ–°ç€é †</a>
  </p>

  <ul>
    {% for comment in comments %}
      <li>
        <p><strong>æŠ•ç¨¿è€…:</strong>
          {% if comment.display_name == 'nickname' %}
            {{ comment.user.username }}
          {% else %}
            éå…¬é–‹
          {% endif %}
        </p>
        <p>{{ comment.content }}</p>

        <!-- âœ… æ—¥ä»˜ï¼šå³ä¸‹å¯„ã›ç”¨ -->
        <p class="comment-date">{{ comment.created_at|date:"Y/m/d H:i" }}</p>

        <!-- ã„ã„ã­ -->
        <form method="POST" action="{% url 'todo:toggle_like' comment.id %}" style="display:inline;">
            {% csrf_token %}
            {% with comment.likes.count as like_count %}
                <button type="submit" class="btn">ğŸ‘ {{ like_count|default:"ã„ã„ã­" }}</button>
            {% endwith %}
        </form>
      </li>
    {% empty %}
      <li>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
    {% endfor %}
  </ul>

  <!-- ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form method="POST" action="{% url 'todo:add_comment' task.id %}">
    {% csrf_token %}
    <textarea name="content" rows="3" cols="40" maxlength="150" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br>
    <small>0/150æ–‡å­—</small><br><br>

    <p>ğŸ‘¤ æŠ•ç¨¿è€…è¡¨ç¤ºè¨­å®šï¼š</p>
    <label><input type="radio" name="display_name" value="nickname" checked> ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§è¡¨ç¤ºã™ã‚‹</label><br>
    <label><input type="radio" name="display_name" value="anonymous"> æŠ•ç¨¿è€…åã‚’éå…¬é–‹ã«ã™ã‚‹</label><br>
    <p><small>ã“ã®ç«¯æœ«ã‹ã‚‰ã®æŠ•ç¨¿ã«ã¯ç·¨é›†ãƒ»å‰Šé™¤ãŒå¯èƒ½ã§ã™</small></p>

    <button type="submit" class="btn">ï¼‹ ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </button>
</form>
{% elif view == "comment" %}
  <p>â€»ã“ã®ã‚¿ã‚¹ã‚¯ã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãã¾ã›ã‚“ã€‚</p>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.edit-memo-btn').forEach(button => {
      button.addEventListener('click', () => {
        const id = button.dataset.memoId;
        document.getElementById(`edit-memo-modal-${id}`).style.display = 'block';
      });
    });

    document.querySelectorAll('.delete-memo-btn').forEach(button => {
      button.addEventListener('click', () => {
        const id = button.dataset.memoId;
        document.getElementById(`delete-memo-modal-${id}`).style.display = 'block';
      });
    });

    document.querySelectorAll('.cancel-btn').forEach(button => {
      button.addEventListener('click', () => {
        button.closest('.modal').style.display = 'none';
      });
    });
  });
</script>

{% endblock %}