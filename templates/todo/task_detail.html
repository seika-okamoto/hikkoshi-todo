{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/task_detail.css' %}">
{% endblock %}

{% block content %}
  <div class="task-detail-wrapper">
    <p class="back-link-inside"><a href="{% url 'todo:index' %}">â† æˆ»ã‚‹</a></p>
    <h2>{{ task.title }}</h2>
    <div class="tab-switch">
      <a href="?view=memo" class="{% if view == 'memo' %}active-tab{% endif %}">ğŸ“ ãƒ¡ãƒ¢</a>
      <a href="?view=comment&sort={{ sort|default:'newest' }}" class="{% if view == 'comment' %}active-tab{% endif %}">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</a>
    </div>

    {% if view == "memo" %}
      <h3>ğŸ“ è‡ªåˆ†ç”¨ãƒ¡ãƒ¢</h3>
      {% for memo in memos %}
        <div class="task-card">
          <div class="task-left">
            <span class="task-title">ãƒ»{{ memo.context }}ï¼ˆ{{ memo.created|date:"Y/m/d H:i" }}ï¼‰</span>
          </div>
          <div class="task-actions">
            <button class="edit-memo-btn" data-memo-id="{{ memo.id }}" data-context="{{ memo.context }}">ğŸ“ç·¨é›†</button>
            <button class="delete-memo-btn" data-memo-id="{{ memo.id }}">ğŸ—‘ï¸å‰Šé™¤</button>
          </div>
        </div>

        <div class="modal edit-modal" id="edit-memo-modal-{{ memo.id }}" style="display:none;">
          <p class="modal-title">å†…å®¹ã‚’ç·¨é›†ã—ã¦ãã ã•ã„</p>
          <form method="POST" action="{% url 'todo:edit_memo' memo.id %}">
            {% csrf_token %}
            <textarea name="context">{{ memo.context }}</textarea><br>
            <button type="submit">âœ…ä¿å­˜</button>
            <button type="button" class="cancel-btn">âŒã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </form>
        </div>

        <div class="modal delete-modal" id="delete-memo-modal-{{ memo.id }}" style="display:none;">
          <p style="margin-bottom: 16px;">ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
          <form method="POST" action="{% url 'todo:delete_memo' memo.id %}">
            {% csrf_token %}
            <button type="submit">ğŸ—‘ï¸å‰Šé™¤</button>
            <button type="button" class="cancel-btn">âŒã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </form>
        </div>
      {% endfor %}
      <form method="POST" action="{% url 'todo:add_memo' task.id %}">
        {% csrf_token %}
        <textarea name="context" rows="3" cols="40" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea><br>
        <button type="submit" class="btn">â• ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
      </form>
    {% endif %}

    <!-- ğŸ‘‡ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºï¼šviewã«é–¢ä¿‚ãªããƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¹ã‚¯ãªã‚‰å¸¸æ™‚è¡¨ç¤º -->
    {% if task.is_template %}
      <h3>ğŸ’¬ ã¿ã‚“ãªã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ{{ comment_count }}ä»¶ï¼‰</h3>

      {% if view == "comment" %}
        <p>ä¸¦ã³æ›¿ãˆï¼š
          <a href="?view=comment&sort=popular" {% if sort == 'popular' %}style="font-weight: bold;"{% endif %}>äººæ°—é †</a> /
          <a href="?view=comment&sort=newest" {% if sort == 'newest' %}style="font-weight: bold;"{% endif %}>æ–°ç€é †</a>
        </p>
      {% endif %}

   <ul>
    {% for comment in comments %}
      <li>
        <p><strong>æŠ•ç¨¿è€…:</strong> {{ comment.user.username }}</p>
        <p>{{ comment.content }}</p>
        <p class="comment-date">{{ comment.created_at|date:"Y/m/d H:i" }}</p>
      </li>
    {% empty %}
      <li>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
    {% endfor %}
  </ul>

      <!-- âœ… æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼šã“ã“ã«1ã¤ã ã‘æ®‹ã™ -->
      <form method="POST" action="{% url 'todo:add_comment' task.id %}">
        {% csrf_token %}
        <textarea name="content" rows="3" cols="40" maxlength="150" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br>
        <small>0/150æ–‡å­—</small><br><br>

        <p>ğŸ‘¤ æŠ•ç¨¿è€…è¡¨ç¤ºè¨­å®šï¼š</p>
        <label><input type="radio" name="display_name" value="nickname" checked> ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§è¡¨ç¤ºã™ã‚‹</label><br>
        <label><input type="radio" name="display_name" value="anonymous"> æŠ•ç¨¿è€…åã‚’éå…¬é–‹ã«ã™ã‚‹</label><br>
        <p><small>ã“ã®ç«¯æœ«ã‹ã‚‰ã®æŠ•ç¨¿ã«ã¯ç·¨é›†ãƒ»å‰Šé™¤ãŒå¯èƒ½ã§ã™</small></p>

        <button type="submit" class="btn">â• ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ </button>
      </form>
    {% else %}
      <p>â€»ã“ã®ã‚¿ã‚¹ã‚¯ã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãã¾ã›ã‚“ã€‚</p>
    {% endif %}
  </div>

  <script>
  // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ããƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  document.querySelectorAll('.edit-memo-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const memoId = btn.dataset.memoId;
      document.getElementById(`edit-memo-modal-${memoId}`).style.display = 'block';
    });
  });

  // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ããƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  document.querySelectorAll('.delete-memo-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const memoId = btn.dataset.memoId;
      document.getElementById(`delete-memo-modal-${memoId}`).style.display = 'block';
    });
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã§é–‰ã˜ã‚‹
  document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.closest('.modal').style.display = 'none';
    });
  });
</script>

{% endblock %}

